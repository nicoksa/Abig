@page
@model Abig2025.Pages.Post.PlansModel
@{
    ViewData["Title"] = "Seleccionar Plan";
}

<style>

    .stats-card-body {
        min-height: 90px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stats-number {
        font-variant-numeric: tabular-nums;
        font-feature-settings: "tnum";
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zero-number {
        font-size: 2.0rem !important; 
        line-height: 1;
    }
</style>

<link rel="stylesheet" href="~/css/stylePost.css" />

<div class="container mt-5 pt-5">
    <!-- Encabezado - Más espacio arriba -->
    <div class="text-center mb-5 pt-4">
        <!-- Agregado pt-4 -->
        <h1 class="fw-bold mb-3 display-5">@(Model.NoPublications ? "¡Necesitas un plan para publicar!" : "Selecciona tu plan")</h1>

        @if (Model.NoPublications)
        {
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Tu plan <strong>@TempData["CurrentPlan"]</strong> no tiene publicaciones disponibles.
                <br>
                <small>Publicaciones restantes: @Model.RemainingPublications</small>
            </div>
        }

        <p class="lead text-muted fs-5">Elige el plan que mejor se adapte a tus necesidades</p>
    </div>

    <!-- Plan actual o mensaje sin plan -->
    @if (Model.CurrentSubscription != null)
    {
        <!-- Usuario TIENE plan activo -->
        <div class="card border-start border-4 border-success shadow-sm mb-5">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-success">
                        <i class="bi bi-briefcase-fill me-2"></i>
                        Tu plan activo
                    </h5>
                    <span class="badge bg-success bg-opacity-25 text-success">
                        <i class="bi bi-check-circle me-1"></i>Activo
                    </span>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-8">
                        <!-- Encabezado del plan -->
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle me-4">
                                <i class="bi bi-award-fill text-success fs-3"></i>
                            </div>
                            <div>
                                <h3 class="fw-bold mb-1">@Model.CurrentSubscription.Plan?.Name</h3>
                                <div class="d-flex align-items-center">
                                    @if (Model.CurrentSubscription.Plan?.Price == 0)
                                    {
                                        <span class="badge bg-success fs-6 me-3">Plan Gratuito</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info fs-6 me-3">$@Model.CurrentSubscription.Plan?.Price/mes</span>
                                    }
                                    <span class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        Válido hasta @Model.CurrentSubscription.EndDate.ToString("dd/MM/yyyy")
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Estadísticas -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center py-3 stats-card-body">
                                        <h2 class="fw-bold @(Model.RemainingPublications <= 0 ? "text-danger display-3" : "text-success") mb-1
                    @(Model.RemainingPublications == 0 ? "zero-number" : "")">
                                            @Model.RemainingPublications
                                        </h2>
                                        <p class="text-muted small mb-0">Disponibles</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center py-3 stats-card-body">
                                        <h2 class="fw-bold text-secondary mb-1">
                                            @Model.UsedPublications
                                        </h2>
                                        <p class="text-muted small mb-0">Usadas</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center py-3 stats-card-body">
                                        <h2 class="fw-bold text-primary mb-1">
                                            @(Model.CurrentSubscription.Plan?.MaxPublications == -1 ? "∞" : Model.CurrentSubscription.Plan?.MaxPublications.ToString())
                                        </h2>
                                        <p class="text-muted small mb-0">Total del plan</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje según disponibilidad -->
                        <div class="alert @(Model.RemainingPublications > 0 ? "alert-success" : "alert-danger") mt-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi @(Model.RemainingPublications > 0 ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill")"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading fw-bold">
                                        @if (Model.RemainingPublications > 0)
                                        {
                                            <text>¡Listo para publicar!</text>
                                        }
                                        else
                                        {
                                            <text>Sin publicaciones disponibles</text>
                                        }
                                    </h6>
                                    <p class="mb-0">
                                        @if (Model.RemainingPublications > 0)
                                        {
                                            <text>Puedes crear @Model.RemainingPublications publicación(es) más con tu plan actual.</text>
                                        }
                                        else
                                        {
                                            <text>Has utilizado todas las publicaciones de tu plan actual.</text>
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            @if (Model.RemainingPublications > 0)
                            {
                                <a asp-page="/Post/Post" class="btn btn-success btn-lg">
                                    <i class="bi bi-plus-square me-2"></i>
                                    Crear publicación
                                </a>
                                <a href="#planes-disponibles" class="btn btn-outline-primary">
                                    <i class="bi bi-eye me-2"></i>
                                    Ver otros planes
                                </a>
                            }
                            else
                            {
                                <a href="#planes-disponibles" class="btn btn-danger btn-lg">
                                    <i class="bi bi-arrow-up-circle me-2"></i>
                                    Actualizar plan
                                </a>
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-clock-history me-2"></i>
                                    Esperar renovación
                                </button>
                            }
                            <button class="btn btn-outline-secondary">
                                <i class="bi bi-file-text me-2"></i>
                                Ver detalles
                            </button>
                        </div>

                        <!-- Info adicional -->
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="fw-bold text-muted mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Información del plan
                            </h6>
                            <ul class="list-unstyled small">
                                <li class="mb-2">
                                    <i class="bi bi-check text-success me-2"></i>
                                    Inicio: @Model.CurrentSubscription.StartDate.ToString("dd/MM/yyyy")
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check text-success me-2"></i>
                                    Fin: @Model.CurrentSubscription.EndDate.ToString("dd/MM/yyyy")
                                </li>
                                <li class="mb-0">
                                    <i class="bi bi-check text-success me-2"></i>
                                    Estado: @(Model.CurrentSubscription.IsActive ? "Activo" : "Inactivo")
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Usuario NO tiene plan activo -->
        <div class="card border-2 border-dashed border-secondary mb-5 bg-light">
            <div class="card-body p-5">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-4">
                                <div class="bg-white p-3 rounded-circle shadow-sm">
                                    <i class="bi bi-clipboard-x text-secondary fs-2"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h3 class="fw-bold text-secondary mb-2">Sin plan activo</h3>
                                <p class="text-muted mb-3">
                                    Actualmente no tienes un plan de publicaciones activo.
                                    Para crear y publicar propiedades, selecciona uno de nuestros planes disponibles.
                                </p>
                                <div class="alert alert-light border mb-0">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Puedes empezar con nuestro <strong>plan gratuito</strong> para probar el servicio.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                        <a href="#planes-disponibles" class="btn btn-secondary btn-lg w-100 w-lg-auto">
                            <i class="bi bi-rocket-takeoff me-2"></i>
                            Comenzar ahora
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Todos los planes en una misma fila -->
    <div id="planes-disponibles" class="mb-5 pt-3">
        <!-- Agregado pt-3 -->
        <h3 class="mb-4 pb-2 border-bottom">
            <i class="bi bi-grid-3x3-gap-fill text-primary me-2"></i>
            Planes disponibles
        </h3>
        <div class="row row-cols-1 row-cols-md-3 g-4">
            <!-- Plan gratuito -->
            @if (Model.FreePlan != null && Model.CurrentSubscription == null)
            {
                <div class="col">
                    <div class="card h-100 border-0 shadow-lg hover-shadow transition-all">
                        <div class="card-header bg-gradient-primary text-white py-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold">Plan Básico</h5>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column py-4">
                            <div class="text-center mb-4">
                                <h2 class="display-4 fw-bold text-primary mb-1">Gratis</h2>
                                <p class="text-muted">/ 1 publicación</p>
                            </div>

                            <ul class="list-unstyled mb-4 flex-grow-1">
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <strong>1 publicación gratis</strong>
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    Válido por 30 días
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    Visibilidad básica
                                </li>

                            </ul>

                            <div class="mt-auto pt-3">
                                <form method="post" class="d-inline w-100">
                                    <input type="hidden" asp-for="SelectedPlanId" value="@Model.FreePlan.PlanId" />
                                    <button type="submit" class="btn btn-primary btn-lg w-100 py-3">
                                        <i class="bi bi-check-circle me-2"></i>
                                        <strong>Seleccionar Plan Gratuito</strong>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Planes de pago -->
            @foreach (var plan in Model.AvailablePlans.Where(p => p.Price > 0))
            {
                <div class="col">
                    <div class="card h-100 border-0 shadow-lg hover-shadow transition-all
                                    @(plan.Name.Contains("Premium") ? "premium-card" : "standard-card")">

                        @if (plan.Name.Contains("Premium"))
                        {
                            <div class="card-header bg-gradient-warning text-dark py-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold">@plan.Name</h5>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="card-header bg-gradient-info text-white py-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold">@plan.Name</h5>
                                </div>
                            </div>
                        }

                        <div class="card-body d-flex flex-column py-4">
                            <div class="text-center mb-4">
                                <h2 class="display-4 fw-bold @(plan.Name.Contains("Premium") ? "text-warning" : "text-info") mb-1">
                                    $@plan.Price.ToString("N0")
                                </h2>
                                <p class="text-muted">/@plan.DurationDays días</p>
                            </div>

                            <ul class="list-unstyled mb-4 flex-grow-1">
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill @(plan.Name.Contains("Premium") ? "text-warning" : "text-info") me-2"></i>
                                    <strong>
                                        @if (plan.MaxPublications == -1)
                                        {
                                            <text>Publicaciones ilimitadas</text>
                                        }
                                        else
                                        {
                                            @($"{plan.MaxPublications} publicaciones")
                                        }
                                    </strong>
                                </li>
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill @(plan.Name.Contains("Premium") ? "text-warning" : "text-info") me-2"></i>
                                    Destacado en resultados
                                </li>
                                @if (plan.IncludesContractManagement)
                                {
                                    <li class="mb-3">
                                        <i class="bi bi-check-circle-fill @(plan.Name.Contains("Premium") ? "text-warning" : "text-info") me-2"></i>
                                        Gestión de contratos
                                    </li>
                                }
                                <li class="mb-3">
                                    <i class="bi bi-check-circle-fill @(plan.Name.Contains("Premium") ? "text-warning" : "text-info") me-2"></i>
                                    Soporte prioritario 24/7
                                </li>

                            </ul>

                            <div class="mt-auto pt-3">
                                <form method="post" class="d-inline w-100">
                                    <input type="hidden" asp-for="SelectedPlanId" value="@plan.PlanId" />
                                    <button type="submit"
                                            class="btn @(plan.Name.Contains("Premium") ? "btn-warning" : "btn-info") btn-lg w-100 py-3 text-white">
                                        <i class="bi bi-credit-card me-2"></i>
                                        <strong>Seleccionar Plan</strong>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Información adicional -->
    <div class="alert alert-light border-info shadow-sm mb-5">
        <h5 class="alert-heading text-info">
            <i class="bi bi-info-circle-fill me-2"></i>Información importante
        </h5>
        <div class="row mt-3">
            <div class="col-md-3 mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-arrow-repeat text-info me-3 fs-5"></i>
                    <div>
                        <h6 class="mb-1 fw-bold">Renovación automática</h6>
                        <p class="text-muted small mb-0">Los planes se renuevan automáticamente</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-x-circle text-info me-3 fs-5"></i>
                    <div>
                        <h6 class="mb-1 fw-bold">Cancelación flexible</h6>
                        <p class="text-muted small mb-0">Cancela en cualquier momento</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-headset text-info me-3 fs-5"></i>
                    <div>
                        <h6 class="mb-1 fw-bold">Soporte incluido</h6>
                        <p class="text-muted small mb-0">Todas las publicaciones incluyen soporte</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-eye text-info me-3 fs-5"></i>
                    <div>
                        <h6 class="mb-1 fw-bold">Visibilidad limitada</h6>
                        <p class="text-muted small mb-0">Las publicaciones gratis tienen visibilidad básica</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para continuar sin plan (solo si tiene publicaciones) -->
    @if (Model.RemainingPublications > 0)
    {
        <div class="text-center mt-4 pt-3 border-top">
            <a asp-page="/Post/Post" class="btn btn-outline-primary btn-lg px-5">
                <i class="bi bi-arrow-right me-2"></i>Continuar con plan actual
            </a>
        </div>
    }
</div>

