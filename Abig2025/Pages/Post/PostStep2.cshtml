@page "{draftId?}"
@model Abig2025.Pages.Post.PostStep2Model
@{
    ViewData["Title"] = "Publicar Inmueble - Paso 2";
}

<link rel="stylesheet" href="~/css/stylePost.css" />

<div class="container mt-4 pt-5">
    <!-- Campo oculto para draft -->
    <input type="hidden" asp-for="DraftId" />
    
    <!-- Barra de progreso -->
    <div class="progress-container mb-5">
        <div class="progress-steps-wrapper">
            <div class="progress-steps step-2">
                <div class="step completed">
                    <div class="step-circle bg-primary text-white">1</div>
                    <div class="step-label fw-bold">Principales</div>
                </div>
                <div class="step-connector active"></div>
                <div class="step active">
                    <div class="step-circle bg-primary text-white">2</div>
                    <div class="step-label fw-bold">Multimedia</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-circle">3</div>
                    <div class="step-label">Extras</div>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-circle">4</div>
                    <div class="step-label">Publicar</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Encabezado -->

    <div class="row justify-content-center" style="padding-top:35px">
        <div class="col-lg-10">
            <!-- Encabezado -->
            <div class="d-flex align-items-center mb-5 p-4 bg-white rounded-3 shadow-sm border-start border-4 border-primary">
                <div class="flex-shrink-0 me-4">
                    <i class="bi bi-camera-video fs-1 text-primary"></i>
                </div>
                <div>
                    <h1 class="fw-bold mb-2 text-primary">¡Agregá fotos y videos de tu propiedad!</h1>
                    <p class="lead text-muted mb-0">Las propiedades con mejores fotos reciben hasta 5 veces más consultas</p>
                </div>
            </div>

            <!-- Mostrar errores de validación -->
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <h5 class="alert-heading">Errores de validación:</h5>
                    <ul class="mb-0">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }

            @if (Model.UploadErrors?.Count > 0)
            {
                <div class="alert alert-warning">
                    <h5 class="alert-heading">Errores en imágenes:</h5>
                    <ul class="mb-0">
                        @foreach (var error in Model.UploadErrors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                </div>
            }

            <!-- Formulario de multimedia -->
            <form method="post" enctype="multipart/form-data" style="padding-top:15px">
                <!-- Sección para subir imágenes mejorada -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 py-3">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-images me-2"></i>Imágenes de la propiedad
                        </h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-4">
                            <div class="file-upload-wrapper">
                                <label for="Imagenes" class="form-label fw-bold">Subí hasta 20 fotos (mínimo 5 recomendadas)</label>
                                <div class="file-upload-input">
                                    <input type="file" class="form-control visually-hidden" id="Imagenes" name="Imagenes" multiple accept="image/*">
                                    <label for="Imagenes" class="file-upload-label">
                                        <div class="file-upload-content">
                                            <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
                                            <p class="mt-2 mb-1 fw-bold">Arrastrá tus fotos aquí o haz clic para seleccionar</p>
                                            <p class="small text-muted">Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB por imagen</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- vista previa de imágenes -->
                        <div id="preview-container" class="row g-3 mt-3" style="min-height: 150px;">
                            @if (Model.Data.TempImages?.Count > 0)
                            {
                                @foreach (var image in Model.Data.TempImages)
                                {
                                    <div class="col-6 col-md-4 col-lg-3" data-image-id="@image.FileName">
                                        <div class="card h-100 border-0 shadow-sm image-preview-card">
                                            <div class="ratio ratio-1x1">
                                                <img src="~/uploads/temp/@image.FileName"
                                                     class="card-img-top object-fit-cover"
                                                     alt="@image.OriginalName"
                                                     loading="lazy"
                                                     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjhmOCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSIgZmlsbD0iIzY2NiI+SW1hZ2VuPC90ZXh0Pjwvc3ZnPg=='">
                                            </div>
                                            <div class="card-footer bg-white border-0 py-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-truncate" style="max-width: 100px" title="@image.OriginalName">
                                                        @image.OriginalName
                                                    </small>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-danger delete-server-image"
                                                            data-filename="@image.FileName"
                                                            title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                            
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }

                                <!-- Mostrar contador -->
                                <div class="col-12 mt-2">
                                    <div id="image-counter" class="badge @(Model.Data.TempImages.Count >= 5 ? "bg-success" : "bg-warning")">
                                        @Model.Data.TempImages.Count imágenes subidas
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="col-12 text-center py-5 text-muted" id="empty-message">
                                    <i class="bi bi-images fs-1 opacity-50"></i>
                                    <p class="mt-2">Todavía no subiste ninguna foto</p>
                                </div>
                            }
                        </div>

                        <!-- Consejos para fotos -->
                        <div class="alert alert-info mt-4">
                            <h5 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>Consejos para mejores fotos:</h5>
                            <ul class="mb-0">
                                <li>Usa buena iluminación natural</li>
                                <li>Muestra todos los ambientes importantes</li>
                                <li>Evita fotos oscuras o borrosas</li>
                                <li>Comienza con la foto más atractiva</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Sección para video  -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 py-3">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-camera-reels me-2"></i>Video (opcional)
                        </h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-3">
                            <label for="VideoUrl" class="form-label fw-bold">Enlace de YouTube o Vimeo</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-link-45deg"></i></span>
                                <input type="url" class="form-control" id="VideoUrl" name="Step2.VideoUrl" 
                                       value="@Model.Data.VideoUrl" placeholder="https://youtube.com/tu-video">
                            </div>
                            <small class="text-muted">Pegá el enlace completo de tu video. Los videos aumentan un 30% las consultas.</small>
                        </div>

                        <!-- Vista previa del video (aparece cuando se ingresa URL) -->
                        <div id="video-preview" class="ratio ratio-16x9 mt-3 @(string.IsNullOrEmpty(Model.Data.VideoUrl) ? "d-none" : "")">
                            @if (!string.IsNullOrEmpty(Model.Data.VideoUrl))
                            {
                                <iframe src="@Model.Data.VideoUrl" frameborder="0" allowfullscreen></iframe>
                            }
                            else
                            {
                                <iframe src="" frameborder="0" allowfullscreen></iframe>
                            }
                        </div>
                    </div>
                </div>

                <!-- Botones de navegación mejorados -->
                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                    <!-- Volver al paso 1 -->
                    <button type="submit" asp-page-handler="Back"
                            class="btn btn-outline-secondary px-4 py-2">
                        <i class="bi bi-arrow-left me-2"></i>Anterior
                    </button>

                    <!-- Ir al paso 3 -->
                    <button type="submit" class="btn btn-primary px-4 py-2">
                        Siguiente <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Usar DataTransfer para acumular archivos
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('Imagenes');
            const previewContainer = document.getElementById('preview-container');
            const emptyMessage = document.getElementById('empty-message');
            const form = document.querySelector('form');

            // Array para mantener TODAS las imágenes seleccionadas por el usuario
            let allClientFiles = [];

            // Mostrar imágenes existentes del servidor al cargar la página
            updateImageCounter();

            fileInput.addEventListener('change', function(event) {
                if (this.files.length > 0) {
                    // Agregar nuevos archivos al array
                    Array.from(this.files).forEach(file => {
                        // Verificar si ya existe (por nombre y tamaño)
                        const exists = allClientFiles.some(f =>
                            f.name === file.name && f.size === file.size
                        );

                        if (!exists && allClientFiles.length < 20) {
                            allClientFiles.push(file);
                        }
                    });

                    // Actualizar el input con TODOS los archivos
                    updateFileInputWithAllFiles();

                    // Actualizar vista previa
                    updatePreview();
                }
            });

            function updateFileInputWithAllFiles() {
                const dataTransfer = new DataTransfer();

                // Agregar todos los archivos al DataTransfer
                allClientFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });

                // Actualizar el input de archivos
                fileInput.files = dataTransfer.files;

                // Log para debug
                console.log('Archivos en input:', fileInput.files.length);
            }

            function updatePreview() {
                // Ocultar mensaje de vacío si hay imágenes
                if (emptyMessage && (allClientFiles.length > 0 ||
                    document.querySelectorAll('[data-image-id]').length > 0)) {
                    emptyMessage.style.display = 'none';
                }

                // Crear contenedor para nuevas imágenes
                const newImagesRow = document.createElement('div');
                newImagesRow.className = 'row g-3';
                newImagesRow.id = 'client-images-row';

                // Limpiar solo las imágenes del cliente (no las del servidor)
                const existingClientRow = document.getElementById('client-images-row');
                if (existingClientRow) {
                    existingClientRow.remove();
                }

                // Agregar nuevas imágenes del cliente
                allClientFiles.forEach((file, index) => {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const col = document.createElement('div');
                        col.className = 'col-6 col-md-4 col-lg-3';
                        col.dataset.clientImage = 'true';
                        col.dataset.fileIndex = index;

                        const card = document.createElement('div');
                        card.className = 'card h-100 border-0 shadow-sm image-preview-card';

                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'ratio ratio-1x1';

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'card-img-top object-fit-cover';
                        img.alt = file.name;
                        img.style.objectFit = 'cover';

                        const cardFooter = document.createElement('div');
                        cardFooter.className = 'card-footer bg-white border-0 py-2';
                        cardFooter.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-truncate" style="max-width: 100px" title="${file.name}">
                                    ${file.name}
                                </small>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-client-image"
                                        data-index="${index}" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;

                        imgContainer.appendChild(img);
                        card.appendChild(imgContainer);
                        card.appendChild(cardFooter);
                        col.appendChild(card);
                        newImagesRow.appendChild(col);
                    };

                    reader.readAsDataURL(file);
                });

                // Agregar al contenedor principal
                previewContainer.appendChild(newImagesRow);

                updateImageCounter();
            }

            // Manejar eliminación de imágenes del cliente
            previewContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-client-image')) {
                    const button = e.target.closest('.remove-client-image');
                    const index = parseInt(button.dataset.index);

                    // Eliminar del array
                    allClientFiles.splice(index, 1);

                    // Actualizar vista y input
                    updatePreview();
                    updateFileInputWithAllFiles();

                    // Mostrar notificación
                    showToast('Imagen eliminada de la selección', 'info');
                }
            });

            function getTotalImageCount() {
                // Imágenes del servidor
                const serverImages = document.querySelectorAll('[data-image-id]').length;
                // Imágenes del cliente (nuevas)
                const clientImages = allClientFiles.length;
                return serverImages + clientImages;
            }

            function updateImageCounter() {
                const counterElement = document.getElementById('image-counter');
                const totalImages = getTotalImageCount();

                if (counterElement) {
                    counterElement.textContent = `${totalImages} imágenes`;
                    counterElement.className = `badge ${totalImages >= 5 ? 'bg-success' : 'bg-warning'}`;
                }
            }

            // Configurar drag and drop
            const fileUploadLabel = document.querySelector('.file-upload-label');

            if (fileUploadLabel) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadLabel.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadLabel.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadLabel.addEventListener(eventName, unhighlight, false);
                });

                fileUploadLabel.addEventListener('drop', handleDrop, false);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight() {
                fileUploadLabel.style.borderColor = '#0d6efd';
                fileUploadLabel.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
            }

            function unhighlight() {
                fileUploadLabel.style.borderColor = '#dee2e6';
                fileUploadLabel.style.backgroundColor = '';
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    // Simular cambio en el input
                    const dataTransfer = new DataTransfer();
                    Array.from(files).forEach(file => {
                        dataTransfer.items.add(file);
                    });
                    fileInput.files = dataTransfer.files;

                    // Disparar evento change
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }

            // Validación antes de enviar el formulario - VERSIÓN MEJORADA
            form.addEventListener('submit', function(e) {
                // Asegurar que el input tenga todos los archivos acumulados
                updateFileInputWithAllFiles();

                const totalImages = getTotalImageCount();

                // Detectar qué botón se presionó
                const submitter = e.submitter;
                const isBackButton = submitter &&
                    (submitter.textContent.includes('Anterior') ||
                     submitter.classList.contains('btn-outline-secondary'));

                console.log('Botón presionado:', isBackButton ? 'Anterior' : 'Siguiente');

                // Validación solo para el botón "Siguiente"
                if (!isBackButton) {
                    // Solo validar mínimo de imágenes para "Siguiente"
                    if (totalImages < 1) {
                        if (!confirm('¿Estás seguro de continuar sin subir imágenes? Las propiedades con fotos reciben más consultas.')) {
                            e.preventDefault();
                            return false;
                        }
                    }
                }

                // Validar máximo de imágenes (para ambos botones)
                if (totalImages > 20) {
                    alert('El límite máximo es 20 imágenes. Por favor, elimina algunas imágenes antes de continuar.');
                    e.preventDefault();
                    return false;
                }

                console.log('Enviando formulario con', allClientFiles.length, 'imágenes del cliente');
                return true;
            });

            // Función para forzar la actualización del input antes de enviar (seguridad adicional)
            function forceUpdateBeforeSubmit() {
                updateFileInputWithAllFiles();
                console.log('Forzando actualización de archivos antes del submit');
            }

            // Agregar event listener adicional para asegurar que se actualicen los archivos
            const backButton = document.querySelector('button[type="submit"][asp-page-handler="Back"]');
            const nextButton = document.querySelector('button[type="submit"]:not([asp-page-handler])');

            if (backButton) {
                backButton.addEventListener('click', forceUpdateBeforeSubmit);
            }
            if (nextButton) {
                nextButton.addEventListener('click', forceUpdateBeforeSubmit);
            }
        });

        // Vista previa del video (mantener igual)
        document.addEventListener('DOMContentLoaded', function() {
            const videoUrlInput = document.getElementById('VideoUrl');
            const videoPreview = document.getElementById('video-preview');

            if (videoUrlInput && videoPreview) {
                const iframe = videoPreview.querySelector('iframe');

                // Configurar vista previa inicial si ya hay un video
                updateVideoPreview(videoUrlInput.value);

                videoUrlInput.addEventListener('input', function() {
                    updateVideoPreview(this.value);
                });

                function updateVideoPreview(videoUrl) {
                    if (videoUrl && isValidVideoUrl(videoUrl)) {
                        const embedUrl = getEmbedUrl(videoUrl);

                        if (embedUrl && iframe) {
                            iframe.src = embedUrl;
                            videoPreview.classList.remove('d-none');
                        }
                    } else {
                        videoPreview.classList.add('d-none');
                    }
                }

                function isValidVideoUrl(url) {
                    return url.includes('youtube.com') ||
                           url.includes('youtu.be') ||
                           url.includes('vimeo.com');
                }

                function getEmbedUrl(url) {
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        let videoId = '';

                        if (url.includes('youtube.com/watch?v=')) {
                            videoId = url.split('v=')[1];
                        } else if (url.includes('youtu.be/')) {
                            videoId = url.split('youtu.be/')[1];
                        }

                        if (videoId) {
                            // Limpiar parámetros adicionales
                            const ampersandPosition = videoId.indexOf('&');
                            if (ampersandPosition !== -1) {
                                videoId = videoId.substring(0, ampersandPosition);
                            }

                            return `https://www.youtube.com/embed/${videoId}`;
                        }
                    } else if (url.includes('vimeo.com')) {
                        const videoId = url.split('vimeo.com/')[1];
                        if (videoId) {
                            // Limpiar parámetros adicionales
                            const questionMarkPosition = videoId.indexOf('?');
                            const cleanVideoId = questionMarkPosition !== -1
                                ? videoId.substring(0, questionMarkPosition)
                                : videoId;

                            return `https://player.vimeo.com/video/${cleanVideoId}`;
                        }
                    }

                    return null;
                }
            }
        });

        //  Función para eliminar imágenes del servidor usando AJAX
        function deleteServerImage(fileName) {
            if (!confirm('¿Eliminar imagen?')) {
                return;
            }

            // Obtener el draftId
            const draftIdInput = document.querySelector('input[name="DraftId"]');
            const draftId = draftIdInput ? draftIdInput.value : null;

            if (!draftId) {
                alert('Error: No se encontró el draft');
                return;
            }

            // Mostrar loading
            const deleteButton = document.querySelector(`[data-filename="${fileName}"]`);
            if (deleteButton) {
                deleteButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                deleteButton.disabled = true;
            }

            // Crear formulario dinámico para la solicitud
            const formData = new FormData();
            formData.append('fileName', fileName);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            // Enviar solicitud AJAX
            fetch(`?handler=DeleteImage&draftId=${draftId}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    // Eliminar el elemento de la vista con animación
                    const imageElement = document.querySelector(`[data-image-id="${fileName}"]`);
                    if (imageElement) {
                        // Agregar animación de desvanecimiento
                        imageElement.style.transition = 'opacity 0.3s';
                        imageElement.style.opacity = '0';

                        // Eliminar después de la animación
                        setTimeout(() => {
                            imageElement.remove();

                            // Actualizar contador
                            updateImageCounter();

                            // Mostrar mensaje de éxito
                            showToast('Imagen eliminada correctamente', 'success');

                            // Si no quedan imágenes del servidor, mostrar mensaje de vacío
                            const serverImages = document.querySelectorAll('[data-image-id]').length;
                            const clientImages = window.allClientFiles ? window.allClientFiles.length : 0;

                            if (serverImages === 0 && clientImages === 0) {
                                const emptyMessage = document.getElementById('empty-message');
                                if (emptyMessage) {
                                    emptyMessage.style.display = 'block';
                                }
                            }
                        }, 300);
                    }
                } else {
                    throw new Error('Error al eliminar la imagen');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error al eliminar la imagen', 'danger');
                // Restaurar botón
                if (deleteButton) {
                    deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteButton.disabled = false;
                }
            })
            .finally(() => {
                // Restaurar botón si aún existe (por si acaso)
                setTimeout(() => {
                    if (deleteButton && deleteButton.innerHTML.includes('hourglass')) {
                        deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                        deleteButton.disabled = false;
                    }
                }, 1000);
            });
        }

        //  Función para mostrar notificaciones
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            let container;

            if (!toastContainer) {
                // Crear contenedor si no existe
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(container);
            } else {
                container = toastContainer;
            }

            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show`;
            toast.style.cssText = 'min-width: 250px; margin-bottom: 10px; animation: slideIn 0.3s ease-out;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            `;

            container.appendChild(toast);

            // Auto-eliminar después de 3 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // Estilos CSS para animaciones
        const style = document.createElement('style');
        style.textContent = `
  

            .image-preview-card {
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .image-preview-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
        `;
        document.head.appendChild(style);

        // Event listener para botones de eliminar imágenes del servidor
        document.addEventListener('DOMContentLoaded', function() {
            // Para imágenes del servidor
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-server-image')) {
                    const button = e.target.closest('.delete-server-image');
                    const fileName = button.dataset.filename;
                    deleteServerImage(fileName);
                }
            });

            //  Prevenir el comportamiento por defecto del botón de eliminar antiguo
            document.addEventListener('submit', function(e) {
                // Si el submit viene de un botón dentro de una imagen, prevenirlo
                if (e.target.matches('button[formaction*="DeleteImage"]')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });

            //  allClientFiles global para que sea accesible desde otras funciones
            window.allClientFiles = allClientFiles;
            window.updateImageCounter = updateImageCounter;
        });
    </script>
}