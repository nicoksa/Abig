@page "{draftId?}"
@model Abig2025.Pages.Post.PostStep2Model
@{
    ViewData["Title"] = "Publicar Inmueble - Paso 2";
}

<link rel="stylesheet" href="~/css/stylePost.css" />

<style>
    .image-preview-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: move;
    }

    .image-preview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .image-preview-card.dragging {
        opacity: 0.5;
        transform: scale(0.95);
    }

    .image-preview-card.drag-over {
        border: 2px dashed #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }

.main-image-badge {
    position: absolute !important;
    top: 6px !important;
    left: 4px !important;
    z-index: 11 !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    color: #2c3e50 !important;
    padding: 6px 12px !important;
    border-radius: 6px !important;
    font-size: 0.7rem !important;
    font-weight: 600 !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    white-space: nowrap !important;
    pointer-events: none !important;
    max-width: 90px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    width: auto !important;
    height: auto !important;
    border: 1px solid rgba(0, 0, 0, 0.08) !important;
}

    .image-number-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
        background: rgba(0,0,0,0.7);
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: bold;
    }
</style>

<br />
<br />
<br />
<br />
<div class="container mt-4 pt-5">
    <input type="hidden" asp-for="DraftId" />
    
    <div class="row justify-content-center" style="padding-top:35px">
        <div class="col-lg-10">
            <div class="d-flex align-items-center mb-5 p-4 bg-white rounded-3 shadow-sm border-start border-4 border-primary">
                <div class="flex-shrink-0 me-4">
                    <i class="bi bi-camera-video fs-1 text-primary"></i>
                </div>
                <div>
                    <h1 class="fw-bold mb-2 text-primary">¡Agregá fotos y videos de tu propiedad!</h1>
                    <p class="lead text-muted mb-0">Las propiedades con mejores fotos reciben hasta 5 veces más consultas</p>
                </div>
            </div>

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <h5 class="alert-heading">Errores de validación:</h5>
                    <ul class="mb-0">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }

            @if (Model.UploadErrors?.Count > 0)
            {
                <div class="alert alert-warning">
                    <h5 class="alert-heading">Errores en imágenes:</h5>
                    <ul class="mb-0">
                        @foreach (var error in Model.UploadErrors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                </div>
            }

            <form method="post" enctype="multipart/form-data" style="padding-top:15px">
                <!-- Campo oculto para el orden de imágenes -->
                <input type="hidden" id="ImageOrder" name="ImageOrder" value="" />

                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 py-3">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-images me-2"></i>Imágenes de la propiedad
                        </h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-4">
                            <div class="file-upload-wrapper">
                                <label for="Imagenes" class="form-label fw-bold">Subí hasta 20 fotos (mínimo 5 recomendadas)</label>
                                <div class="file-upload-input">
                                    <input type="file" class="form-control visually-hidden" id="Imagenes" name="Imagenes" multiple accept="image/*">
                                    <label for="Imagenes" class="file-upload-label">
                                        <div class="file-upload-content">
                                            <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
                                            <p class="mt-2 mb-1 fw-bold">Arrastrá tus fotos aquí o haz clic para seleccionar</p>
                                            <p class="small text-muted">Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB por imagen</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Vista previa con drag and drop -->
                        <div id="preview-container" class="row g-3 mt-3" style="min-height: 150px;">
                            @if (Model.Data.TempImages?.Count > 0)
                            {
                                @for (int i = 0; i < Model.Data.TempImages.Count; i++)
                                {
                                    var image = Model.Data.TempImages[i];
                                    <div class="col-6 col-md-4 col-lg-3 image-item" 
                                         data-image-id="@image.FileName"
                                         data-is-server="true"
                                         draggable="true">
                                        <div class="card h-100 border-0 shadow-sm image-preview-card">
                                            <div class="ratio ratio-1x1 position-relative">
                                                @if (i == 0)
                                                {
                                                    <span class="main-image-badge">
                                                        <i class="bi bi-star-fill"></i> Principal
                                                    </span>
                                                }
                                                <span class="image-number-badge">@(i + 1)</span>
                                                <img src="~/uploads/temp/@image.FileName"
                                                     class="card-img-top object-fit-cover"
                                                     alt="@image.OriginalName"
                                                     loading="lazy"
                                                     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjhmOCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSIgZmlsbD0iIzY2NiI+SW1hZ2VuPC90ZXh0Pjwvc3ZnPg=='">
                                            </div>
                                            <div class="card-footer bg-white border-0 py-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-truncate" style="max-width: 100px" title="@image.OriginalName">
                                                        @image.OriginalName
                                                    </small>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-danger delete-server-image"
                                                            data-filename="@image.FileName"
                                                            title="Eliminar">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }

                                <div class="col-12 mt-3">
                                    <div class="alert alert-info">
                                        <i class="bi bi-hand-index-thumb me-2"></i>
                                        <strong>Tip:</strong> Arrastrá las imágenes para cambiar su orden. La primera imagen será la principal.
                                    </div>
                                </div>

                                <div class="col-12 mt-2">
                                    <div id="image-counter" class="badge @(Model.Data.TempImages.Count >= 5 ? "bg-success" : "bg-warning")">
                                        @Model.Data.TempImages.Count imágenes subidas
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="col-12 text-center py-5 text-muted" id="empty-message">
                                    <i class="bi bi-images fs-1 opacity-50"></i>
                                    <p class="mt-2">Todavía no subiste ninguna foto</p>
                                </div>
                            }
                        </div>

                        <div class="alert alert-info mt-4">
                            <h5 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>Consejos para mejores fotos:</h5>
                            <ul class="mb-0">
                                <li>Usa buena iluminación natural</li>
                                <li>Muestra todos los ambientes importantes</li>
                                <li>Evita fotos oscuras o borrosas</li>
                                <li>La primera foto es la más importante - será la imagen principal</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 py-3">
                        <h5 class="mb-0 fw-bold text-primary">
                            <i class="bi bi-camera-reels me-2"></i>Video (opcional)
                        </h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-3">
                            <label for="VideoUrl" class="form-label fw-bold">Enlace de YouTube </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-link-45deg"></i></span>
                                <input type="url" class="form-control" id="VideoUrl" name="Step2.VideoUrl" 
                                       value="@Model.Data.VideoUrl" placeholder="https://youtube.com/tu-video">
                            </div>
                            <small class="text-muted">Pegá el enlace completo de tu video. Los videos aumentan un 30% las consultas.</small>
                        </div>

                        <div id="video-preview" class="ratio ratio-16x9 mt-3 @(string.IsNullOrEmpty(Model.Data.VideoUrl) ? "d-none" : "")">
                            @if (!string.IsNullOrEmpty(Model.Data.VideoUrl))
                            {
                                <iframe src="@Model.Data.VideoUrl" frameborder="0" allowfullscreen></iframe>
                            }
                            else
                            {
                                <iframe src="" frameborder="0" allowfullscreen></iframe>
                            }
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                    <button type="submit" asp-page-handler="Back"
                            class="btn btn-outline-secondary px-4 py-2">
                        <i class="bi bi-arrow-left me-2"></i>Anterior
                    </button>

                    <button type="submit" class="btn btn-primary px-4 py-2">
                        Siguiente <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/Post/postStep2.js"></script>
}