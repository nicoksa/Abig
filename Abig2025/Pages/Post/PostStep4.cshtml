@page "{draftId?}"
@model Abig2025.Pages.Post.PostStep4Model
@{
    ViewData["Title"] = "Publicar Inmueble - Paso 4";
}

<link rel="stylesheet" href="~/css/stylePost.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" />

<div class="container mt-4 pt-5">
    <!-- Barra de progreso -->
    <div class="progress-container mb-5">
        <div class="progress-steps-wrapper">
            <div class="progress-steps step-4">
                <div class="step completed">
                    <div class="step-circle bg-primary text-white">1</div>
                    <div class="step-label fw-bold">Principales</div>
                </div>
                <div class="step-connector active"></div>
                <div class="step completed">
                    <div class="step-circle bg-primary text-white">2</div>
                    <div class="step-label fw-bold">Multimedia</div>
                </div>
                <div class="step-connector active"></div>
                <div class="step completed">
                    <div class="step-circle bg-primary text-white">3</div>
                    <div class="step-label">Extras</div>
                </div>
                <div class="step-connector"></div>
                <div class="step active">
                    <div class="step-circle bg-primary text-white">4</div>
                    <div class="step-label">Publicar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Encabezado -->
    <div class="mb-4 text-center" style="padding-top:35px">
        <h1 class="fw-bold mb-2">¡Estás a un paso de terminar!</h1>
        <p class="lead text-muted">Selecciona el plan con el que querés publicar</p>
    </div>


    <!-- Formulario de selección de plan -->
    <form method="post" style="padding-top:25px">
        <!-- Plan actual -->
      

      
        @if (Model.FreePlan != null)
        {
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Plan actual (@Model.CurrentSubscription?.Plan?.Name ?? "Gratuito")</h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                               name="SelectedPlan" id="PlanActual" value="PlanActual" checked>
                        <label class="form-check-label fw-bold" for="PlanActual">
                            @(Model.CurrentSubscription?.Plan?.Name ?? Model.FreePlan.Name)
                            @if (Model.CurrentSubscription?.Plan?.Price == 0 || Model.FreePlan.Price == 0)
                            {
                                <text>- Gratis</text>
                            }
                            else
                            {
                                <text>- $@(Model.CurrentSubscription?.Plan?.Price.ToString("N0") ?? "0")/mes</text>
                            }
                        </label>
                        <p class="text-muted mt-1">
                            Publicaciones restantes: @Model.RemainingPublications
                            @if (Model.CurrentSubscription?.Plan?.MaxPublications == -1)
                            {
                                <text>(Ilimitadas)</text>
                            }
                        </p>
                        @if (Model.CurrentSubscription?.EndDate != null)
                        {
                            <p class="text-muted mb-0">
                                Vence: @Model.CurrentSubscription.EndDate.ToString("dd/MM/yyyy")
                            </p>
                        }
                    </div>
                </div>
            </div>
        }

        @if (Model.AvailablePlans.Any())
        {
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Actualizar tu plan</h5>
                    <p class="mb-0 text-muted">Obtén más visibilidad y beneficios</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var plan in Model.AvailablePlans)
                        {
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 @(plan.Name.Contains("Destacada") ? "border-warning" :
                                                                                    plan.Name.Contains("Vip") ? "border-primary" : "")">
                            <div class="card-header @(plan.Name.Contains("Destacada") ? "bg-warning text-dark" :
                                                                                    plan.Name.Contains("Vip") ? "bg-primary text-white" : "bg-light")">
                                <h5 class="mb-0">@plan.Name</h5>
                            </div>
                            <div class="card-body">
                                <h3 class="card-title pricing-card-title">
                                    @if (plan.Price == 0)
                                            {
                                                <text>Gratis</text>
                                            }
                                            else
                                            {
                                                @($"${plan.Price:N0}")
                                            }
                                            <small class="text-muted fw-light">/@plan.DurationDays días</small>
                                        </h3>
                                        <ul class="list-unstyled mt-3 mb-4">
                                            <li class="mb-2">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                @if (plan.MaxPublications == -1)
                                                {
                                                    <text>Publicaciones ilimitadas</text>
                                                }
                                                else
                                                {
                                                    @($"{plan.MaxPublications} publicaciones")
                                                }
                                            </li>
                                            <li class="mb-2">
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                @plan.DurationDays días de visibilidad
                                            </li>
                                            @if (plan.IncludesContractManagement)
                                            {
                                                <li class="mb-2">
                                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                    Gestión de contratos
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        @if (plan.Price == 0)
                                        {
                                            <button type="button" class="btn btn-outline-primary w-100"
                                                    onclick="document.getElementById('SelectedPlan').value = '@plan.PlanId'">
                                                Seleccionar
                                            </button>
                                        }
                                        else
                                        {
                                            <a href="/Subscriptions/Subscribe?planId=@plan.PlanId&draftId=@Model.DraftId"
                                               class="btn btn-outline-primary w-100">
                                                Suscribirse
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Nota sobre los planes -->
        <div class="alert alert-info">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="AceptarTerminos" name="AceptarTerminos" required>
                <label class="form-check-label" for="AceptarTerminos">
                    Acepto los términos y condiciones. Duración de mes igual a 30 días. Plan con renovación automática.
                </label>
            </div>
            <div class="invalid-feedback">Debes aceptar los términos y condiciones para continuar</div>
        </div>

        <!-- Botones de acción -->
        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
            <a asp-page="/Post/PostStep3" asp-route-draftId="@Model.DraftId"
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Anterior
            </a>
            <div>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-1"></i>Publicar ahora
                </button>
            </div>
        </div>

        <!-- Campo oculto para el plan seleccionado -->
        <input type="hidden" id="PlanSeleccionado" name="PlanSeleccionado" value="PlanActual">
    </form>
</div>

<script>
    // Función para seleccionar un plan
    function seleccionarPlan(plan) {
        document.getElementById('PlanSeleccionado').value = plan;

        // Remover clases activas de todos los cards
        document.querySelectorAll('.card').forEach(card => {
            card.classList.remove('border-3', 'border-success', 'shadow');
        });

        // Agregar clase activa al plan seleccionado
        const planCard = document.querySelector(`.card-header:contains('${plan}')`).closest('.card');
        planCard.classList.add('border-3', 'border-success', 'shadow');

        // Marcar el radio button correspondiente
        document.getElementById('PlanActual').checked = false;
    }

    // Extensión para :contains selector
    jQuery.expr[':'].contains = function(a, i, m) {
        return jQuery(a).text().toUpperCase().indexOf(m[3].toUpperCase()) >= 0;
    };
</script>

<style>
    .pricing-card-title {
        font-size: 2rem;
    }

    .card {
        transition: all 0.3s ease;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

    .border-3 {
        border-width: 3px !important;
    }
</style>